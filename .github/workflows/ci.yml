name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Install tools
        run: |
          go install github.com/elastic/go-licenser@latest
          go install mvdan.cc/gofumpt@latest
          go install golang.org/x/tools/cmd/goimports@latest

      - name: Check license headers
        run: go-licenser -d -license ASL2-Short -licensor "Andrew Kroh"

      - name: Check gofumpt formatting
        run: |
          output=$(gofumpt -l -extra .)
          if [ -n "$output" ]; then
            echo "Files need formatting:"
            echo "$output"
            exit 1
          fi

      - name: Check goimports formatting
        run: |
          output=$(goimports -l -local github.com/andrewkroh/traefik-github-auth .)
          if [ -n "$output" ]; then
            echo "Files need formatting:"
            echo "$output"
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Build
        run: go build ./...

      - name: Test
        run: go test ./...

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Integration test
        run: go test -tags integration -v -count=1 ./...

  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - uses: goreleaser/goreleaser-action@v6
        with:
          args: release --snapshot --clean
